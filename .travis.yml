---
dist: bionic
language: minimal

cache:
  directories:
    - /home/travis/.vagrant.d/boxes

jobs:
  include:

    - stage: test
      install:
        - sudo apt-get update && sudo apt-get install -y bridge-utils dnsmasq-base ebtables libvirt-bin libvirt-dev qemu-kvm qemu-utils ruby-dev
        - sudo wget -nv https://releases.hashicorp.com/vagrant/2.2.9/vagrant_2.2.9_x86_64.deb
        - sudo dpkg -i vagrant_2.2.9_x86_64.deb
        - sudo vagrant plugin install vagrant-libvirt vagrant-scp vagrant-reload
      script:
        - openssl genrsa -out salt/keys/saltmaster-box.pem
        - openssl rsa -in salt/keys/saltmaster-box.pem -pubout -out salt/keys/saltmaster-box.pub
        - sudo vagrant up --provider=libvirt
        - sudo vagrant destroy --force

    - stage: release
      install:
        - wget https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh
        - sudo bash install.sh
        - nvm install lts/*
        - npm i -D semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/changelog @semantic-release/npm @semantic-release/github @semantic-release/git @semantic-release/exec @commitlint/cli @commitlint/config-conventional
      deploy:
        provider: script
        skip_cleanup: true
        script:
          - npx semantic-release
        on:
          all_branches: true 

notifications:
  slack:
    secure: mN4ZqfJvwdSMT/QliAQNdW+zwhP9JyuZS7l4pUQ/ZWpKZWgD4h18nv5tgw6VljpSOsilLFrAc4yHoitx2z+Q83Wu3leEXozyQO/6n98yIdqBNduEXl52toUuhmeHtifRdywPyLQgNTGeRbXDusqo1b2EYggsxf5rcrmEUQ0A8uPRJ/QazYHFI93QUoRUOCTSv1AHRfbxICNjN13sui2LJs1wv9Wqlk2RWQRjhWIUAKKElQOuOIDAQsx2CNAsf1xZF85HWMAFZXlSkA+1LJwQXXm1LrSXrTdTbutAX0vWmuKA3Ktnujks51maMSbkrz6QZylqDI/q6BlPdIUK+i96dgR2awMks99BRrlSSkVaDiLDuEGc8tvdwqLbFyq7B3X4vSgy5BsgiAd16kAtr9zsC+lvPUatruJkRsGOAD271S1GueF+yEafuTeuyO6JnIAsmLgALyYYEVw3LWD5IojyD84btwccVcJEMKThKN9gVFnD8F8ACzqaN1kk6fxC7zESOajiytIH/giMFnQ9bxaaC3oKt9YC+YwsPjGU3qOgKHs0ucuVNLcOjiLtRMNabh87NakSLY7Rff5yq1/BBCHnIUw7qjDUCNTSoYG1csF78km8JHA7AZlE05Lro3wODZI2J+wrnqLUK2l2jq4wytHsrNV7nhnGygry0vEK6nyxi3w=
