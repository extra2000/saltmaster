---
dist: bionic
language: minimal

cache:
  directories:
    - /home/travis/.vagrant.d/boxes

jobs:
  include:

    - stage: test
      install:
        - sudo apt-get update && sudo apt-get install -y bridge-utils dnsmasq-base ebtables libvirt-bin libvirt-dev qemu-kvm qemu-utils ruby-dev
        - sudo wget -nv https://releases.hashicorp.com/vagrant/2.2.9/vagrant_2.2.9_x86_64.deb
        - sudo dpkg -i vagrant_2.2.9_x86_64.deb
        - sudo vagrant plugin install vagrant-libvirt vagrant-scp vagrant-reload
      script:
        - openssl genrsa -out salt/keys/saltmaster-box.pem
        - openssl rsa -in salt/keys/saltmaster-box.pem -pubout -out salt/keys/saltmaster-box.pub
        - sudo vagrant up --provider=libvirt
        - sudo vagrant destroy --force

    - stage: release
      install:
        - wget https://raw.githubusercontent.com/creationix/nvm/v0.33.0/install.sh
        - sudo bash install.sh
        - nvm install lts/*
        - npm i -D semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/changelog @semantic-release/npm @semantic-release/github @semantic-release/git @semantic-release/exec @commitlint/cli @commitlint/config-conventional
      deploy:
        provider: script
        skip_cleanup: true
        script:
          - npx semantic-release
        on:
          all_branches: true 

notifications:
  slack:
    secure: cLQLIrkd+8Ck++tHUtctbWzi8y1Yf+bwLBZVDfTzyspBb1068/mwSAWg+QNZ/vuvpneotx5WkqZBx1n1M4235XyYyEF13kqCPOFEM5lLWvN6BXiSkAjJ+vMYjtGS4OORRB196UwxOcbU5hwxJmXRtuxQl7V2OjwIObPsiVa8SB0afzYvqBE2CDArJleZiZv6bq94WP250G76Szs97O5rTzVIGOxSHWDwSDEe2pyO/BUp24TV/mfWCbthoIekzc8h1pn6YL0s4G8J3832nbYPsDibb7uoZkpMdw4gav6FQFIwoay1EwFLsl6B89VsCJuobsQply0vZWzsf9kdrKtfBOLfJTbsGa1ZN9reT455SbVljWo83RAgQehEcDpQijtssdFIu9bqJ1CS/arSEP8OsOV9a2yEN1shwEnOGrWy4Nou4kUMsvXXWXCSoaBpvmcO9Vppm03Gk/15Z2IQkJoUdWMLafxMkQ7RuzDfAcqfL3y5pA0jMbDz/SG+sFdkOOG17bz2tgs2xCDt7w0qlNKFFLQy+SQ3aDDBlP4ELquUF/0TNES33iKwZGhrrcVgoyagiw9ZA/nE56lotY58UUgFYvNsxi4fOIvcz5Y/AhBpo0FmWrnfZC9KAgNMbp2WC4vuTH/xtrefgdAykj7mnE7vaNuVli/S8i5+XtqhriQfnB0=
